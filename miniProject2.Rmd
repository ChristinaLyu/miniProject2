---
title: "Percentage Difference in Contributions in and out of the State"
author: "Christina Ly & Caroline Li"
date: "3/7/2018"
output: 
  html_document:
    code_folding: hide
---

Git hub link: [https://github.com/ChristinaLyu/miniProject2.git](https://github.com/ChristinaLyu/miniProject2.git)

Introduction: 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
load("house_elections.rda")
load("candidates.rda")
load("committees.rda")
load("contributions.rda")
library(ggplot2)
library(ggthemes)
library(maps)
```


```{r percentage, warning = FALSE, message = FALSE}
#join two data frames: committees and contributions
joined <- 
  committees %>%
  #use left join to keep the information in contributions and put the information in committees in the left
  left_join(contributions, by = "cmte_id")

#create new dataframe group_id with the comittees grouped by the name and state
group_id <-
  joined %>%
  #group the committees by name, and if they have the same name group them by their state
  group_by(cmte_id, cmte_state) %>%
  #summarise the dataframe
  summarise(
    #number of contributions made
    amount = n(),
    #get the number of contributions made to inside of the state
    same = sum(ifelse(state == cmte_state, 1, 0)),
    #contributions to outside of the state
    diff = amount - same)


```

```{r warning = FALSE, message = FALSE}

group_summary <-
  group_id %>%
  #select the rows where same is not NA
  filter(!is.na(same)) %>%
  #put committees for each state together
  group_by(cmte_state) %>%
  #summarise the groups with the total contributions, and the inState, outState contributions and calculate the percentage
  summarise(total = sum(amount),
         inState = sum(same),
         outState = sum(diff), 
         percentageIn = inState / total, 
         percentageOut = outState / total)

group_summary 

group_summary %>%
  #summarise the previous dataframe by the mean of the percentage in State and out of State
  summarise(all = sum(total),
            inS = sum(inState),
            outS = sum(outState),
            meanIn = inS / all,
            meanOut = outS / all
            )

group_summary %>%
  #select the rows with the fewest or the most inState contributions
  filter(percentageIn == max(percentageIn) | 
           percentageOut == max(percentageOut))
```

From the result of the dataset, the states have a mean of 15.61% contributions to committees in the same state, and a mean of 84% contributions to other states. Therefore, most states do contribute to committees out of state. From the dataset we can also get the information that most of the contributions in West Virginia are made to committees within the state and all of the contributions in Puerto Rico are made to committees outside the state. 

```{r amount, warning = FALSE, message = FALSE}
percentage <- 
  joined %>%
  #select rows in which transaction_amt is not NA
  filter(!is.na(transaction_amt)) %>%
  #group the dataframe by the state
  group_by(cmte_state) %>%
  #add a colomn called total representing the total amount of transactions
  mutate(total = sum(transaction_amt))

getPercentage <- function(data) {
  data %>%
    #add columns of sumOut representing the total amount of transaction outside the state and its percentage in the total
    mutate(sumName = sum(transaction_amt),
           percentName = sumName / total) %>%
    select(cmte_state, total, sumName, percentName)
}

percentageIn <- 
  percentage %>%
  filter(cmte_state == state) %>%
  getPercentage() %>%
  select(cmte_state, sumName, percentName)

colnames(percentageIn) <- c("cmte_state", "sumIn", "percentIn")

#remove duplicate rows
percentageIn <- 
  percentageIn[!duplicated(percentageIn), ]

percentageOut <- 
  percentage %>%
  #select the rows where the donation is made to the different states as the committee
  filter(cmte_state != state) %>%
  getPercentage() 

colnames(percentageOut) <- c("cmte_state", "total", "sumOut", "percentOut")

#remove duplicate rows
percentageOut <- 
  percentageOut[!duplicated(percentageOut), ]

#join the two dataframe
percentage_all <- percentageIn %>%
  full_join(percentageOut, by = "cmte_state")
  
all <- 
  percentage %>%
  mutate(inState = ifelse(cmte_state == state, 1, 0)) %>%
  select(cmte_state, inState)
```

```{r, message = FALSE, warning = FALSE, fig.width=15}
bar_plot <- 
  percentage_all %>%
  ggplot(aes(x = factor(cmte_state))) + 
  geom_bar(aes(x = factor(cmte_state), y = percentIn), stat = "identity", fill = "red") 
bar_plot
```


```{r}
state_list <- c("Alabama",
"Alaska",
"Arizona",
"Arkansas",
"California",
"Colorado",
"Connecticut",
"Delaware",
"Florida",
"Georgia",
"Hawaii",
"Idaho",
"Illinois",
"Indiana",
"Iowa",
"Kansas",
"Kentucky",
"Louisiana",
"Maine",
"Maryland",
"Massachusetts",
"Michigan",
"Minnesota",
"Mississippi",
"Missouri",
"Montana",
"Nebraska",
"Nevada",
"New Hampshire",
"New Jersey",
"New Mexico",
"New York",
"North Carolina",
"North Dakota",
"Ohio",
"Oklahoma",
"Oregon",
"Pennsylvania",
"Rhode Island",
"South Carolina",
"South Dakota",
"Tennessee",
"Texas",
"Utah",
"Vermont",
"Virginia",
"Washington",
"West Virginia",
"Wisconsin",
"Wyoming")
states <- map_data("state")
```

```{r, message = FALSE, warning = FALSE, fig.width = 15, fig.height = 12}
i <- 1
stateLower <- list()
for (state in state_list){
  lower <- tolower(state)
  #states$cmte_state <- state.abb[grep(state, states$region)]
  stateLower[[i]] <- lower
  i <- i + 1
}

for(i in seq_along(stateLower)){
  states[ , 5 ][ states[ , 5 ] == stateLower[i] ] <- state.abb[grep(state_list[i], state.name)]
}

states$cmte_state <- states$region

map_per <- inner_join(states, percentage_all, by = "cmte_state")
#remove duplicate rows
map_per <- 
  map_per[!duplicated(map_per), ]

gg <- ggplot()
gg <- gg + theme(legend.position="none")
gg <- gg + geom_map(data=map_per, map=map_per, aes(map_id=cmte_state, x = long, y = lat, fill=percentIn))

gg <- gg + scale_fill_gradient(low = "yellow", high = "red", guide = "colourbar")
gg <- gg + coord_equal() 

gg
```
